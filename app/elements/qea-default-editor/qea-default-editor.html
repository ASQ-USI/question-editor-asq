<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/asq-exercise/asq-exercise.html">
<link rel="import" href="../qea-property-analyzer/qea-property-analyzer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../behaviors/qea-redux-store.html">
<link rel="import" href="../../behaviors/qea-actions-behavior.html">
<link rel="import" href="./qea-property-editor.html">
<link rel="import" href="./qea-general-prop-edit.html">

<dom-module id="qea-default-editor">
  <template>
    <style>
      :host {
        display: flex;
        position: relative;
        height: 100%;
      }
      #leftPanel, #mainArea, #rightPanel{
        height: 100%;
      }
      #leftPanel{
        overflow-y: auto;
        box-sizing: border-box;
        padding: 5px;
        width: 400px;
        border-right: 1px solid #eee;
      }
      #mainArea{
        width: 100%;
        box-sizing: border-box;
        padding: 40px;
      }
      #rightPanel{
        width: 400px;
        border-left: 1px solid #eee;
      }
      #saveChanges{
        position: fixed;
        bottom: 10px;
        right: 270px;
      }
      .sectionTitle{
        font-weight: bold;
        text-transform: uppercase;
        padding: 5px 0;
      }
    </style>
    <qea-property-analyzer id="analyzer"></qea-property-analyzer>
    <div id="leftPanel">


      <div class="sectionTitle">[[questionType]] Properties</div>
      <template is="dom-repeat" items="[[_listOfProp]]">
        <qea-general-prop-edit prop-info=[[item]]
          prop-type=[[item.type]]
          target-Reference=[[_targetFinder]]></qea-general-prop-edit>
      </template>
    </div>
    <div id="mainArea">
      <asq-exercise>

      </asq-exercise>
    </div>
    <div id="rightPanel">

    </div>

    <paper-button raised id="saveChanges" on-tap='_saveChanges'>Save changes</paper-button>

  </template>
  <script>
  (function () {
    'use strict'

    let MyBehavior = {};
    class qeaDefaultEditor {

      get behaviors() {
        return [
          qeaBehaviors.appBehavior,
          qeaBehaviors.actionsBehavior,
          qeaBehaviors.reduxStore
        ];
      }

      beforeRegister(){
        this.is = 'qea-default-editor'
        this.properties = {
          id: {
            type: String
          },
          html:{
            type: String,
            observer: '_htmlChanged'
          },
          questionType:{
            type: String
          },
          _listOfProp:{
            type: Array,
            value: ()=>[]
          }
        }
        this.listeners={
          'changeProp': '_changeProp'
        }
      }

      _htmlChanged(code){
        this.async(()=>{
          if (!this.questionType) {return}
          this.$.analyzer.scanElement(this.questionType).then(
            (analyzer)=>{
              this._insertExampleCode(analyzer);
              this._extractProperties(analyzer);
            }
          )
        }, 100)

      }

      _insertExampleCode(analyzer){
        let placeToInsert = this.html != '' ? this.$.mainArea : this.$$('asq-exercise');
        let code = this.$.analyzer.getExampleCodeAndDesc(analyzer).code
        let tags = this._extraxctTags(code)
        for (let tag of tags) {
          this.importHref(this.resolvePath(tag) )
        }
        this.async(()=>{
          var toLocal = document.createElement('div');
          Polymer.dom(toLocal).innerHTML = code;
          Polymer.dom(placeToInsert).appendChild(toLocal)
        },1000)
      }

      _extraxctTags(code, allTags=false){
        let re;
        if (allTags) {
          re = /\<\/([a-z-]+)\>/gi;
        }else {
          re = /\<\/(asq\-[a-z-]+)\>/gi;
        }
        let result  = Array.from(new Set(code.match(re)));
        for (var i = 0; i < result.length; i++) {
          result[i] = result[i].replace(/[\<\/\>]/g, '')
        }
        return result
      }

      _saveChanges(){
        let html = this.$.mainArea.innerHTML;
        this.dispatch('addElement', this.questionType, html)
        this._reset();
        this.fire('changePage', {selectedPage: 'canvas'})
      }

      _extractProperties(analyzer){
        this._listOfProp = this.$.analyzer.getProperties(analyzer)
      }

      _changeProp(host, value){
        this.$$(this.questionType)[value.name] = value.value;
      }

      _reset(){
        this.id = null,
        this._listOfProp = [];
        this.questionType = null;
        this.html = null;
        let elementToRemove = Polymer.dom(this.$$('asq-exercise')).childNodes
        for (let elem of elementToRemove) {
          Polymer.dom(this.$$('asq-exercise')).removeChild(elem)
        }
      }


    }

    Polymer(qeaDefaultEditor);
  })()
  </script>
</dom-module>
