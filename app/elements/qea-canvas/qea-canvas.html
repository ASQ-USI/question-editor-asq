<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<dom-module id="qea-canvas">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      #canvas{
        padding: 5px;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        position: relative;
      }

      .readyForDrop{
        border: dashed 3px blue;
      }


    </style>
    <div id="canvas" on-mouseover="_allowDrop" on-mouseout="_denyDrop">
        <span class="">drag an element here</span>
        <paper-button raised on-tap='codeInspector'>log code</paper-button>
    </div>

  </template>
  <script>
  (function () {
    'use strict'

    let MyBehavior = {};
    class qeaCanvas {

      get behaviors() {
        return [];
      }

      beforeRegister(){
        this.is = 'qea-canvas'
        this.properties = {
          path: {
            value: '../..'
          },
          isDragging:{
            type: Boolean
          },
          droppedElem:{
            type: Object,
            observer: '_notifyDrop'
          },
          canDrop: {
            type: Boolean,
            value: false
          },
          previousDropBorder:{
            type: Object,
            value: function (){
              return { node: null}
            }
          }
        }
      }

      ready() {
        // if __dirname exist, it means that we are using electron and
        // __dirname is the global path to the app folder
        if (typeof __dirname !== "undefined"){
          this.path = __dirname;
        } else {
          // otherwise set the local path to point to the app folder
          this.path = '../..'
        }
      }

      _notifyDrop(droppedElem){
        // render the dropped element if possible
        // TODO use droppedElem.detail.hover() to get the target
        if (this.canDrop) {
          this._injectDomElement(this.$.canvas, droppedElem.name )
        }
      }

      _importElement(elementName){
      // check if the element is already been imported
        if (!this.$$(elementName)){
          Polymer.Base.importHref(this.path+'/bower_components/'+elementName+'/'+elementName+'.html',
            ()=>{ this.message(elementName + ' imported'); return 1},
            ()=> {this.message('error while importing: '+ elementName); return 0}
          )
        }else {
          this.message(elementName + ' imported');
        }
        return 1;
      }

      _injectDomElement(target, elementName) {
        var dynamicEl;
        this._importElement(elementName);
        dynamicEl = Polymer.Base.create(elementName,{});
        Polymer.dom(target).appendChild(dynamicEl);
        this._toggleDropBorder(false);
      }

      message(message){
        this.fire('fireToast', {text: message})
      }

      codeInspector(){
        console.log(this.$.canvas);
      }

      _allowDrop(e){
        // function called when mouse is over the canvas area
        this.canDrop = true
        if (this.isDragging){
          this._toggleDropBorder(true)
        }
      }

      _denyDrop(){
        // function called when mouse leves the canvas area
        this.canDrop = false
        this._toggleDropBorder(false);
      }

      _toggleDropBorder(isActive, targetNode){
        // toggle the helper dotted blue borders around drop target element
        var isActive = isActive || false;
        var targetNode = targetNode || this.$.canvas;

        if (isActive) {
          // check if there arlready is an helper border in the canvas
          if (this.previousDropBorder.node) {
            this.toggleClass('readyForDrop', false, this.previousDropBorder.node);
          }
          this.previousDropBorder.node = targetNode;
        }else {
          this.previousDropBorder.node = null;
        }
        this.toggleClass('readyForDrop', isActive, targetNode)
      }

    }

    Polymer(qeaCanvas);
  })()

  </script>
</dom-module>
