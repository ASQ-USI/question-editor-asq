<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">
<link rel="import" href="../../behaviors/qea-app-behavior.html">
<link rel="import" href="../../behaviors/qea-redux-store.html">
<link rel="import" href="../../behaviors/qea-actions-behavior.html">
<link rel="import" href="../qea-selector-highlighter/qea-selector-highlighter.html">
<link rel="import" href="../qea-text-editor/qea-text-editor.html">

<dom-module id="qea-canvas">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        width: calc(100% - 306px);
        box-sizing: border-box;
      }
      #canvas{
        width: 100%;
        height: 100%;
        position: relative;
        padding: 5px;
      }
      .qea-selected{
        border: 1px dashed blue;
      }

    </style>
    <qea-text-editor id="textEditor"></qea-text-editor>
    <div id="canvas" on-tap='_selectItem' on-mouseover='_onHovered' on-mouseout='_onUnhovered'>
      <sortable-js handle=".handle" scroll  animation='200' force-Fallback='true' >
        <template is="dom-repeat" items={{objs}}  id="repeater">
          <qea-selector-highlighter
            selected-Id=[[selectedElemId]]
            element-Id=[[item.id]]
            type=[[item.type]]
            content=[[item.html]]>
          </qea-selector-highlighter>
        </template>
      </sortable-js>

    </div>

  </template>
  <script>
  (function () {
    'use strict'

    let MyBehavior = {};
    class qeaCanvas {

      get behaviors() {
        return [
          qeaBehaviors.appBehavior,
          qeaBehaviors.actionsBehavior,
          qeaBehaviors.reduxStore
        ];

      }

      beforeRegister(){
        this.is = 'qea-canvas'
        this.properties = {
          isDragging:{
            type: Boolean
          },
          selectedElemId:{
            type:String
          },
          objs:{
            type: Array,
            statePath: 'elements'
          },
          _hovered:{
            type: Boolean,
            value: false
          },
          droppedElem:{
            type: Object,
            observer: '_notifyDrop'
          },
          isHover:{
            type: Boolean,
            value: false
          }
        }
      }

      _selectItem(event){
        for (var value of event.path) {
          if(value.tagName && value.tagName.toLowerCase() === "qea-selector-highlighter"){
            this.selectedElemId = value.elementId
            return
          }
        }
        this.selectedElemId = null;
      }

      _onHovered() {
        this.toggleClass('qea-selected' , this.isDragging, this.$.canvas)
        this.isHover = true;
      }
      _onUnhovered() {
        this.toggleClass('qea-selected' , false, this.$.canvas);
        this.isHover = false
      }

      _notifyDrop(el){
        this.toggleClass('qea-selected' , false, this.$.canvas)
        if (this.isHover) {
          this.fire('changePage', {selectedPage:'questionEditor', pageData:el.questionDetails});
        }
      }


      insertTextArea(){
        this.$.textEditor.openDialog().then(
          (text)=>{
            if (text) {  this.dispatch('addElement', 'text', text)}
          }
        );
      }

      modifyTextArea(id, code){
        this.$.textEditor.setContent(code)
        this.$.textEditor.openDialog().then(
          (text)=>{
            if (text) {  this.dispatch('editElement',id, text)}
          }
        );
      }



    }

    Polymer(qeaCanvas);
  })()

  </script>
</dom-module>
