<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="qea-main-app">
  <template>
    <style include="iron-flex iron-positioning">
      :host {
        display: block;
        @apply(--layout-fit);
        @apply(--layout-vertical);
      }
      #nav-container{
        background: #fafafa;
        border-left: 1px solid #999;
        width: 300px;
      }
      .tollbarIcon{
        margin: 0 10px;
        color: grey;
      }
      #spinner{
        --asq-spinner-letter-height: 46px;
        --asq-spinner-letter-width: 46px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>


    <qea-toolbar current-Page=[[_currentPage]]></qea-toolbar>


    <section id="canvas-container" class="flex layout horizontal">
      <asq-spinner id='spinner'></asq-spinner>

      <!-- be sure to add the "page-name" attribute to all the new pages inserted -->
      <iron-pages id='pageController' selected={{_currentPage}} attr-for-selected="page-name" class="flex layout horizontal">

        <div class="page page0 layout horizontal flex" page-name='landingPage'>
          <qea-landing-page class="flex"></qea-landing-page>
        </div>

        <div class="page flex layout horizontal page1" page-name='canvas'>
          <qea-canvas id="qeaCanvas"
            class="flex layout horizontal"
            dropped-elem="[[_dropped]]"
            is-dragging="[[_isDragging]]">
          </qea-canvas>
          <nav id="nav-container">
            <qea-questions-list id="questions-list"></qea-questions-list>
          </nav>
        </div>

        <div class="page flex layout horizontal page3" id='questionEditorPage' page-name="questionEditor">

        </div>

      </iron-pages>
    </section>

    <qea-user-response id="notify"></qea-user-response>

  </template>
  <script>
  (function () {
    'use strict';

    class qeaMainApp {
      get behaviors() {
        return [qeaBehaviors.appBehavior];
      }

      beforeRegister() {
        this.is = 'qea-main-app';

        this.listeners = {
          fireToast: '_openToast',
          changePage: '_changePage',
          dragStart: '_dragStart',
          dragStop: '_dragStop',
        };

        this.properties = {
          _isDragging: {
            type: Boolean,
            value: false,
          },
          _dropped: {
            type: Object,
          },
          _currentPage: {
            type: String,
            value: 'landingPage',
          },
        };
      }

      _openToast(host, { type = 'default', text = '', properties }) {
        if (type === 'error') {
          this.$.notify.notifyError('', text, properties);
        } else {
          this.$.notify.notify('', text, properties);
        }
      }

      _dragStart() {
        // receive the event from question-item when drag start
        this._isDragging = true;
      }

      _dragStop(host, droppedElem) {
        // receive the event from question-item when drag stop
        this._isDragging = false;
        if (droppedElem) {
          // render the dropped element
          this._dropped = droppedElem;
        }
      }

      /**
      * Changes iron pages passsing all the informations required by the pages;
      *
      * @param {HTMLElement} host element that has fired the event.
      * @param {{selectedPage: String, pageData: Object, questionInfo: {id:String, props: Object, type: String}}} object passed in the event fire.
      *        pageData: Object contained the informations defined in qea-questions-list. Defined only when drag a question.
      *        questionInfo: Object containing the informations of an already created question
      */
      _changePage(host, { selectedPage, pageData = null, questionInfo = { id: null, props: {}, type: '' } }) {
        for (const page of this.$.pageController.items) {
          if (page.getAttribute('page-name') === selectedPage) {
            if (selectedPage === 'questionEditor') {
              this._moveToquestionPage(questionInfo, pageData);
              return;
            }
            this._currentPage = selectedPage;
            return;
          }
        }
        this._openToast(null, { text: `no page available with name: ${selectedPage}`, type: 'error' });
      }

      /**
      * Moves to the correct editor for the selected question.
      *
      * @param {{id:String, props: Object, type: String}} questionInfo properties and other data of a question
      * @param {Object} pageData Object contained the informations defined in qea-questions-list.
      *         Defined only when event has been fired after having dropped question in the cavas.
      */
      _moveToquestionPage({ id, props, type }, pageData = null) {
        // remove previous editors
        const oldEditors = Polymer.dom(this.$.questionEditorPage).childNodes;
        for (const edit of oldEditors) {
          Polymer.dom(this.$.questionEditorPage).removeChild(edit);
        }
        // if pageData is not defined it means that the selected question has already been been dragged and so imported
        if (!pageData) {
          const name = type || pageData.bowerName;
          const elem = this._createElement(name, true, { questionId: id, restoreState: props });
          elem.classList.add('flex');
          Polymer.dom(this.$.questionEditorPage).appendChild(elem);
          this._currentPage = 'questionEditor';
          return;
        }
        this.toggleAttribute('active', true, this.$.spinner);

        // import the right question editor with all the dependencies
        Polymer.Base.importHref(this.resolveLocalPath(pageData.bowerName),
          () => {
            const name = type || pageData.bowerName;
            const elem = this._createElement(name, true, {});
            this.async(() => {
              Polymer.dom(this.$.questionEditorPage).appendChild(elem);
              elem.classList.add('flex');
              this.toggleAttribute('active', false, this.$.spinner);
              this._currentPage = 'questionEditor';
            }, 1000);
          },
          () => {
            console.error(`failed to import page ${pageData.bowerName}`);
          }
        );
      }

      resolveLocalPath(tagName) {
        const p = typeof __dirname === 'undefined' ? '../..' : __dirname;
        return `${p}/elements/${tagName.toLowerCase()}/${tagName.toLowerCase()}.html`;
      }


    }
    Polymer(qeaMainApp);
  })();

  </script>
</dom-module>
