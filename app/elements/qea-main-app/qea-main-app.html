<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../qea-questions-list/qea-questions-list.html">
<link rel="import" href="../qea-canvas/qea-canvas.html">
<link rel="import" href="../qea-property-analyzer/qea-property-analyzer.html">
<link rel="import" href="../qea-landing-page/qea-landing-page.html">
<link rel="import" href="../qea-toolbar/qea-toolbar.html">
<link rel="import" href="../../behaviors/qea-app-behavior.html">
<link rel="import" href="../asq-text-input-q-editor/asq-text-input-q-editor.html">

<dom-module id="qea-main-app">
  <template>
    <style>
      :host {
        display: block;
      }

      #canvas-container{
        position: absolute;
        top: 64px;
        left: 0;
        bottom: 0;
        right: 0;
      }
      iron-pages {
        width: 100%;
        height: 100%;
      }
      iron-pages > div{
        width: 100%;
        height: 100%;
      }
      #nav-container{
        background: #fafafa;
        border-left: 1px solid #999;
        position: fixed;
        width: 300px;
        top: 0;
        right: 0;
        bottom: 0;
      }
      .tollbarIcon{
        margin: 0 10px;
        color: grey;
      }

    </style>

    <qea-property-analyzer props='{{props}}'></qea-property-analyzer>

    <qea-toolbar current-Page=[[_currentPage]]></qea-toolbar>



    <section id="canvas-container">

      <!-- be sure to add the "page-name" attribute to all the new pages inserted -->
      <iron-pages id='pageController' selected={{_currentPage}} attr-For-Selected="page-name">

        <div class="page page0" page-name='landingPage'>
          <qea-landing-page></qea-landing-page>
        </div>

        <div class="page page1" page-name='canvas'>
          <qea-canvas id="qeaCanvas"
            dropped-elem=[[_dropped]]
            is-dragging=[[_isDragging]]>
          </qea-canvas>
          <nav id="nav-container">
            <qea-questions-list id="questions-list"></qea-questions-list>
          </nav>
        </div>

        <div class="page page3" id='questionEditorPage' page-name='questionEditor'>
          <asq-text-input-q-editor></asq-text-input-q-editor>
        </div>

      </iron-pages>
    </section>

    <paper-toast id="toast" text=[[_toastMessage]] duration='3000' ></paper-toast>

  </template>
  <script>
  (function() {
    'use strict';

    class qeaMainApp {
      get behaviors() {
        return [qeaBehaviors.appBehavior];
      }

      beforeRegister() {
        this.is = 'qea-main-app';

        this.listeners = {
          "fireToast": "_openToast",
          "changePage": "_changePage",
          "dragStart": "_dragStart",
          "dragStop" : "_dragStop"
        },

        this.properties = {
          _toastMessage: {
            type: String,
            value: ''
          },
          _isDragging: {
            type: Boolean,
            value: false
          },
          _dropped: {
            type: Object,
            notify: true
          },
          props: {
            type: Object,
            notify: true
          },
          _currentPage:{
            type: String,
            value: 'landingPage',
            notify: true
          }
        }
      }


      _openToast(host, messageData) {
        this._toastMessage = messageData.text;
        if (messageData.type && messageData.type == 'error') {
          this.$.toast.customStyle['--paper-toast-background-color'] = '#F44336';
          this.$.toast.updateStyles();
        }
        this.$.toast.open();
      }


      _dragStart(host){
        // receive the event from question-item when drag start
        this._isDragging = true;
      }

      _dragStop(host, droppedElem) {
        // receive the event from question-item when drag stop
        this._isDragging = false;
        if (droppedElem) {
          // render the dropped element
          this._dropped = droppedElem;
        }

      }

      _changePage(host, {selectedPage, pageData, questionInfo={id:null, html:''}}){
        for (var page of this.$.pageController.items) {
          if (page.getAttribute('page-name') == selectedPage ){
            // if (selectedPage === 'questionEditor') {
            //   // this._moveToquestionPage(pageData, questionInfo);
            //   return
            // }
            this.$.pageController.selected = selectedPage;
            return
          }
        }
        this.openToast(null, {text: `no page available with name: ${selectedPage}`, type: 'error'})
      }

      // _moveToquestionPage(pageData, questionInfo){
      //   let defaultEdit = {editorBowerName:'defaultEditor', link:null }
      //   let {label, bowerName, customEditor=defaultEdit}= pageData
      //   questionInfo.questionType = questionInfo.questionType || bowerName
      //   if (customEditor.editorBowerName === 'defaultEditor') {
      //     this._insertEditor('qea-default-editor', questionInfo, bowerName);
      //     this.$.pageController.selected = 'questionEditor';
      //   }else {
      //     Polymer.Base.importHref(this.resolvePath(bowerName),
      //       (success)=>{
      //         // TODO
      //       },
      //       (fail)=>{
      //         // TODO
      //       });
      //   }
      // }
      //
      // _insertEditor(editorBowerName, questionInfo, questionBowerName){
      //   let oldEditors = Polymer.dom(this.$.questionEditorPage).childNodes
      //   if (oldEditors.length>0 && oldEditors[0].tagName.toLowerCase() == editorBowerName) {
      //     oldEditors[0].html = questionInfo.html;
      //     oldEditors[0].questionType = questionBowerName;
      //     oldEditors[0].id = questionInfo.id;
      //   }else {
      //     for (let edit of oldEditors) {
      //       Polymer.dom(this.$.questionEditorPage).removeChild(edit)
      //     }
      //     let elem = this._createElement(editorBowerName, true, questionInfo )
      //     Polymer.dom(this.$.questionEditorPage).appendChild(elem)
      //   }
      // }


    }
    Polymer(qeaMainApp);
  })();

  </script>
</dom-module>
