<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/hydrolysis/hydrolysis-analyzer.html">
<link rel="import" href="../../behaviors/qea-inspect-behavior.html">

<!-- use this element as a library to analize a polymer elements -->
<dom-module id="qea-property-analyzer">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <hydrolysis-analyzer id='hydro'
         src=[[src]]
         analyzer={{_analyzer}}
         transitive=[[recursively]]
         loading={{loading}}
         clean>
    </hydrolysis-analyzer>

  </template>
  <script>
  (function () {
    'use strict'

    let MyBehavior = {};
    class qeaPropertyAnalyzer {

      get behaviors() {
        return [qeaBehaviors.inspectBehavior];
      }

      beforeRegister(){
        this.is = 'qea-property-analyzer'
        this.properties = {
          // path for the element to be analyzed
          src: {
            type: String
          },
          // result of the analisis
          _analyzer: {
            type: Object,
            notify: true
          },

          recursively: {
            type: Boolean,
            value: false
          },
          loading: {
            type: Boolean,
            notify: true
          },
          props: {
            type: Array,
            computed: '_computeProps(_analyzer)',
            value: ()=>[],
            notify: true
          }

        }
      }

      _computeProps(analyzer){
        if (!analyzer || Object.keys(analyzer).length === 0
            || !analyzer.elements || analyzer.elements.length == 0) {
          return []
        }
        return this.getProperties(analyzer);
      }

      // analyze element passed as parameter using hydrolysis and return
      // the result as Promise
      scanElement(tagName){
        return new Promise(
          (resolve, reject)=>  {
            this.src = this.resolvePath(tagName)
            this.$.hydro.analyze()
            this.addEventListener('_analyzer-changed', ()=> {
              // console.log('analy',  this._analyzer);
              if (this._analyzer == null) {
                reject(new Error('impossible to analyze element '+ this.src))
              }
              resolve(this._analyzer)
            })
          }
        )
      }

      // return the list of behaviors of the element analyzed
      getBehaviors(analyzer){
        return this.getElements(analyzer)[0].behaviors;
      }

      // return the info about the analized element.
      // if tagName is not specified it return a list contaning all the custom
      // elements founded in the scanned file
      getElements(analyzer, tagName){
        if (tagName) {
          return analyzer.elementsByTagName[tagName];
        }
        return analyzer.elements;
      }

      // return the properties of the analyzed element;
      getProperties(analyzer){
        return this.getElements(analyzer)[0].properties;
      }

      // return an object contaning the description and the example code of the
      // analized element
      getExampleCodeAndDesc (analyzer){
       let el = this.getElements(analyzer)[0] || null;
       if (el == null) {
         return new Error('impossible to extract code from '+ this.src)
       }
       let descAndCode = el.desc;
       let code = descAndCode.substring(descAndCode.indexOf(`<${el.is}`),
                  descAndCode.indexOf(`</${el.is}>`)+ `</${el.is}>`.length)
       let desc = descAndCode.substring( 0, descAndCode.indexOf(`## Example`))
       return {description: desc, code: code}
      }


      reset(){
        this.src = '';
        this._analyzer = null;
      }



    }

    Polymer(qeaPropertyAnalyzer);
  })()
  </script>
</dom-module>
