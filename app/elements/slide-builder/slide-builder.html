<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../behaviors/select-behavior.html">
<link rel="import" href="../wrapper-selector/wrapper-selector.html">

<dom-module id="slide-builder">
  <template>
    <style>
      :host {
        display: block;
      }
      .container{
        width: 100%;
        height: 100%;
        position: relative;
        padding: 10px
      }
      paper-material{
        box-sizing: border-box;
        padding: 10px;
        margin: auto;
        width: 800px;
        height: 620px;
      }
      .readyForDrop{
        border: dashed 3px blue;
      }

      .selected{
        border: 2px solid red;
      }


    </style>
    <div class="container">
      <paper-material id='slide' elevation="4" on-mouseover='_allowDrop'
          on-mouseout='_denyDrop' on-dblclick='_select' >
        <span class="">drag an element here</span>

        <paper-button raised on-tap='codeInspector'>log code</paper-button>
        <span>double tap to select</span>
      </paper-material>
    </div>

  </template>
  <script>
    Polymer({
      is: 'slide-builder',
      behaviors: [MyBehaviors.selectBehavior],

      properties: {
        path: {
          value: '../..'
        },
        isDragging:{
          type: Boolean,
          observer: '_disableBorder'
        },
        droppedElem:{
          type: Object,
          observer: 'renderDropped'
        },
        canDrop: {
          type: Boolean,
          value: false
        }
      },
      _injectElement: function(idTarget, elementName){
        // if __dirname exist, it means that we are using electron and
        // __dirname is the global path to the app folder
        if (typeof __dirname !== "undefined"){
          this.path = __dirname;
        } else {
          // otherwise set the local path to point to the app folder
          this.path = '../..'
        }

        // check if the element is already been imported
        if (!this.$$(elementName)){
          Polymer.Base.importHref(this.path+'/bower_components/'+elementName+'/'+elementName+'.html', ()=>{
            var dynamicEl = document.createElement(elementName);
            dynamicEl.id = this._idGenerator()
            dynamicEl.childName = elementName;
            this._changeSelection(dynamicEl.id)

            Polymer.dom(this.$[idTarget]).appendChild(this.generateWrapper(dynamicEl));
            this.message( elementName+' inserted')
          })
        }else {
          var dynamicEl = document.createElement(elementName);
          dynamicEl.id = this._idGenerator()
          dynamicEl.childName = elementName;
          this._changeSelection(dynamicEl.id)
          Polymer.dom(this.$[idTarget]).appendChild(this.generateWrapper(dynamicEl));
          this.message( elementName+' inserted')
        }
      },

      message: function(message){
        this.fire('fireToast', {text: message})
      },

      renderDropped: function(droppedElem){
        // render the element dropped
        if (this.canDrop) {
          this._injectElement('slide', droppedElem.name)
        }
      },

      codeInspector: function(){
        console.log(this.$.slide);
      },

      _allowDrop: function(){
        if (this.canDrop) { return}
        this.canDrop = true
        if (this.isDragging){
          this.toggleClass('readyForDrop', true, this.$.slide)
        }
      },

      _denyDrop: function(){
        if (!this.canDrop) { return}
        this.canDrop = false
        this.toggleClass('readyForDrop', false, this.$.slide)
      },

      _disableBorder:function(value){
        if (!value) {
          this.toggleClass('readyForDrop', false, this.$.slide)
        }
      },

      _select: function(e){
        var nodeDetail = this.findRootNode(e)
        var mainNode = nodeDetail.element;
        if (!this._changeSelection(mainNode.id)){return};

        var placeToInsert = nodeDetail.parent;
        var wrapped = this.generateWrapper(mainNode)
        Polymer.dom(placeToInsert).appendChild(wrapped)
      },

      _changeSelection: function(mainNodeID){
        if (this.$$('wrapper-selector')) {
          if (Polymer.dom(this.$$('wrapper-selector').$.content).getDistributedNodes()[0].id === mainNodeID) {
            // user has clicked on a already wrapped element
            return false
          }

          var parent = Polymer.dom(this.$$('wrapper-selector')).parentNode;
          var child = Polymer.dom(this.$$('wrapper-selector').$.content).getDistributedNodes()[0]

          Polymer.dom(parent).appendChild(child)
          this.$$('wrapper-selector').remove()
          if (mainNodeID === 'slide') {
            return false
          }
        }else if (!this.$$('wrapper-selector') && mainNodeID === 'slide') {
          return false;
        }


        return true;

      },

      _idGenerator: function(){
        var S4 = function() {
          return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        };
        return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
      },

      checkCose: function () {
        console.log(this.$$('wrapper-selector'));
      }




    });
  </script>
</dom-module>
