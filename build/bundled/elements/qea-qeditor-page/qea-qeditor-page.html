<html><head></head><body><dom-module id="qea-qeditor-page"><template><style include="iron-flex">:host{display:block;}</style><app-route query-params="{{query}}" route="{{route}}" pattern="/:qid/edit" data="{{routeData}}"></app-route><iron-localstorage name="my-app-storage" value="{{exerciseStore}}"></iron-localstorage><div id="editorContainer" class="flex layout horizontal"></div></template><script>
(function () {
  'use strict';

  Polymer({

    is: 'qea-qeditor-page',
    behaviors: [qeaBehaviors.appBehavior, qeaBehaviors.actionsBehavior, qeaBehaviors.reduxStore],
    observers: ['_questionChanged(routeData.qid, query.type)'],
    properties: {
      /**
      * exercises to store in local storage
      */
      exerciseStore: {
        type: Object,
        notify: true
      },
      /**
      * Route
      */
      route: {
        type: Object,
        notify: true
      },
      /**
      * route data
      */
      routeData: {
        type: Object,
        notify: true
      },
      /**
      * Route query
      */
      query: {
        type: Object,
        notify: true
      }
    },

    _questionChanged: function _questionChanged(qid, type) {
      var _this = this;

      this.debounce('changeQuestion', function () {
        _this.$$('iron-localstorage').reload();
        var editorType = type + '-editor';

        if (qid && _this.exerciseStore) {
          if (qid === 'new') {
            // create new question
            _this.dispatch('addElement', type, null, {});
            var newQid = _this.getState().elements.slice(-1)[0].id;
            _this.set('exerciseStore.elements', _this.getState().elements);

            _this.set('routeData.qid', newQid);
          } else {
            // restore
            _this.fire('toggleSpinner', true);
            _this._clearPage();

            // <replace:start>
            Polymer.Base.importHref(_this.__resolveLocalPath(editorType), function () {
              // successful import
              _this._renderEditor(qid, editorType, _this.query.eid);
            }, function () {
              // unsuccessful import
              _this.fire('toggleSpinner', false);
              _this.fire('fireToast', { text: "We can't find that editor", type: 'error' });
              _this.fire('changePage', { pageURL: '404' });
            }, false);
            // <replace:stop>
          }
        } else if (qid === '') {
          _this.set('route.path', '404');
        }
      });
    },

    _renderEditor: function _renderEditor(qid, editorType, eid) {
      var _this2 = this;

      var props = null;
      if (qid) {
        // restore properties
        props = this._searchQuestion(qid);
        if (!props) {
          this.fire('toggleSpinner', false);
          this.fire('fireToast', { text: "We can't find that question", type: 'error' });
          return;
        }
      }

      // create
      var elem = Polymer.Base.create(editorType, { id: qid, exerciseId: eid, restoreState: props });
      elem.classList.add('flex');
      this.async(function () {
        Polymer.dom(_this2.$.editorContainer).appendChild(elem);
        _this2.fire('toggleSpinner', false);
      }, 1000);
    },

    _searchQuestion: function _searchQuestion(qid) {
      if (this.exerciseStore) {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = this.exerciseStore.elements[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var question = _step.value;

            if (question.id === qid) {
              return question.props;
            }
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      }
      return null;
    },

    _clearPage: function _clearPage() {
      var oldEditors = Polymer.dom(this.$.editorContainer).childNodes;
      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = oldEditors[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          var edit = _step2.value;

          Polymer.dom(this.$.editorContainer).removeChild(edit);
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2.return) {
            _iterator2.return();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }
    }

  });
})();</script></dom-module></body></html>